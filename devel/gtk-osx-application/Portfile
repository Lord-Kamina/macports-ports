# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem 1.0
PortGroup       active_variants 1.1
PortGroup       conflicts_build 1.0

name            gtk-osx-application
conflicts       ige-mac-integration
version         2.1.3
license         LGPL-2.1
set branch      [join [lrange [split ${version} .] 0 1] .]
categories      devel
maintainers     {elelay @elelay} openmaintainer

description Mac OS X menu bar integration library for GTK quartz

long_description \
        A simple library whose purpose is to \
        allow GTK quartz applications to integrate with \
        the Mac OS X menu bar. Requires gtk2 or gtk3 and its \
        dependencies to be built with variant +quartz

homepage        https://wiki.gnome.org/Projects/GTK%2B/OSX/Integration

platforms       darwin

set myname      gtk-mac-integration
master_sites    gnome:sources/gtk-mac-integration/${branch}/
distname        ${myname}-${version}
use_xz          yes

# sha256 from upstream, rmd160 computed locally
checksums           sha256  d5f72302daad1f517932194d72967a32e72ed8177cfa38aaf64f0a80564ce454 \
                    rmd160  3ec9e5e1063d1b4407b10bfca5389841f49bc069 \
                    size    368108

depends_build   port:pkgconfig

pre-configure {

  if {![active_variants $gtk_version quartz ""]} {
    ui_error "
${subport} is meant to be used only in a GTK quartz
development environment but your version of GTK does not
support quartz.  Please make sure that port $gtk_version and all its
dependencies are built with variants +quartz and try again.
"
    error "$gtk_version +quartz not installed."
  }
}

set python_version          3.7

variant gtk2 requires python27 conflicts gtk3 description {Build with support for GTK+-2.0} {
    global gtk_version
    set gtk_version             gtk2
    depends_lib-append          port:gtk2 \
                                port:py27-pygtk \
                                port:py27-gobject
    require_active_variants     py27-gobject quartz
    require_active_variants     py27-cairo quartz
    require_active_variants     py27-pygtk quartz
    require_active_variants     libglade2 quartz
    configure.args-append       --with-gtk2 --without-gtk3 --enable-introspection=yes
}

variant gtk3 conflicts gtk2 description {Build with support for GTK+-3.0} {
    global gtk_version
    set gtk_version             gtk3
    depends_lib-append          port:gtk3
    configure.args-append       --with-gtk3 --without-gtk2 --enable-introspection=yes
}

variant python27 conflicts python35 python36 python37 python38 description {Build bindings for Python 2.7} {
    depends_lib-append          port:python27
    require_active_variants     py27-cairo quartz
}

variant python35 requires gtk3 conflicts python27 python36 python37 python38 description {Build bindings for Python 3.5} {
    depends_lib-append          port:python35
}

variant python36 requires gtk3 conflicts python27 python35 python37 python38 description {Build bindings for Python 3.6} {
    depends_lib-append          port:python36
}

variant python37 requires gtk3 conflicts python27 python35 python36 python38 description {Build bindings for Python 3.7} {
    depends_lib-append          port:python37
}

variant python38 requires gtk3 conflicts python27 python35 python36 python37 description {Build bindings for Python 3.8} {
    depends_lib-append          port:python38
}

if {[variant_isset python27]} {
    global python_version
    set python_version          2.7
} elseif {[variant_isset python35]} {
    global python_version
    set python_version          3.5
} elseif {[variant_isset python36]} {
    global python_version
    set python_version          3.6
} elseif {[variant_isset python37]} {
    global python_version
    set python_version          3.7
} elseif {[variant_isset python38]} {
    global python_version
    set python_version          3.8
}

if {![variant_isset gtk2] && ![variant_isset python27]} {
    global python_version
    if {![variant_isset python35] && \
        ![variant_isset python36] && \
        ![variant_isset python37] && \
        ![variant_isset python38] && \
        ![variant_isset no_introspection]} {
            default_variants-append +python37
        }
    if {![variant_isset no_introspection]} {
            default_variants-append +gtk3
    }
    depends_lib-append [string map {. ""} port:py${python_version}-gobject3]
    if {![variant_isset python38]} {
            conflicts_build [string map {. ""} py${python_version}-gobject]
    }
} \
elseif {[variant_isset gtk2]} {
            default_variants-append +python27 +no_introspection
        } \
elseif {![variant_isset gtk2] && \
        [variant_isset python27]} {
            default_variants-append +gtk3
            depends_lib-append port:py27-gobject3
}


set python_prefix           ${frameworks_dir}/Python.framework/Versions/${python_version}
configure.args-append           --enable-python=yes --with-pkgconfigdir="${python_prefix}/lib/pkgconfig" --datarootdir="${prefix}/share"

variant no_introspection requires gtk2 python27 conflicts gtk3 description {Disable gobject-introspection support} {
    depends_lib-delete          port:py27-gobject
    configure.env-append        PYGOBJECT_CODEGEN=${python_prefix}/bin/pygobject-codegen-2.0
    configure.env-append        PYGTK_CODEGEN=${python_prefix}/bin/pygtk-codegen-2.0
    configure.args-replace      --enable-introspection=yes --enable-introspection=no
    configure.args-append       --disable-introspection
}

pre-fetch {
    global python_prefix, python_version
    set python_prefix           ${frameworks_dir}/Python.framework/Versions/${python_version}
    configure.python            ${python_prefix}/bin/python${python_version}
    configure.pkg_config_path   ${python_prefix}/lib/pkgconfig
}

subport gtk-osx-application-gtk3 {
    PortGroup active_variants 1.1
    
    depends_lib port:gtk-osx-application
    require_active_variants gtk-osx-application "gtk3 python37"
}

subport gtk-osx-application-common-gtk3 {
  PortGroup           obsolete 1.0
  
  replaced_by         gtk-osx-application
}

subport gtk-osx-application-gtk2 {
    PortGroup active_variants 1.1
    
    depends_lib port:gtk-osx-application
    require_active_variants gtk-osx-application "gtk2 no_introspection"
}

subport gtk-osx-application-common-gtk2 {
  PortGroup           obsolete 1.0
  
  replaced_by         gtk-osx-application
}

configure.ccache        no
configure.cmd-append    --libdir=${prefix}/lib --includedir=${prefix}/include

patchfiles-append       patch-bindings-python-gtkmacintegration-Makefile-in.diff \
                        patch-bindings-python-gtk_osxapplication-Makefile-in.diff \
                        patch-configure-python-syntax.diff

livecheck.type          gnome
livecheck.name          ${myname}
